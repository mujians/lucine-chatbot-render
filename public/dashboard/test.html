<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard - Lucine di Natale</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .pending { color: #FF9800; }
        button { 
            background: #c41e3a; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #a01729; }
        #results { 
            background: #f9f9f9; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .metric { 
            display: inline-block; 
            margin: 5px 10px; 
            padding: 8px 12px; 
            background: #e3f2fd; 
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Dashboard Lucine di Natale</h1>
    
    <div class="test-section">
        <h2>🔐 Test Login</h2>
        <button onclick="testLogin()">Test Login Quick</button>
        <button onclick="testLoginNormal()">Test Login Normale</button>
        <div id="login-status" class="pending">Non testato</div>
    </div>

    <div class="test-section">
        <h2>📊 Test Analytics</h2>
        <button onclick="testAnalytics()">Test Analytics API</button>
        <div id="analytics-status" class="pending">Non testato</div>
        <div id="analytics-data"></div>
    </div>

    <div class="test-section">
        <h2>👥 Test Operators</h2>
        <button onclick="testOperatorStatus()">Test Operator Status</button>
        <div id="operator-status" class="pending">Non testato</div>
    </div>

    <div class="test-section">
        <h2>🔌 Test WebSocket</h2>
        <button onclick="testWebSocket()">Test WebSocket Connection</button>
        <div id="websocket-status" class="pending">Non testato</div>
    </div>

    <div class="test-section">
        <h2>📱 Test Dashboard UI</h2>
        <button onclick="window.open('/dashboard/', '_blank')">Apri Dashboard</button>
        <button onclick="testDashboardFiles()">Test File Loading</button>
        <div id="ui-status" class="pending">Non testato</div>
    </div>

    <div id="results"></div>

    <script>
        let authToken = null;
        const API_BASE = window.location.origin;
        
        function log(message) {
            const results = document.getElementById('results');
            results.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        function updateStatus(elementId, status, className) {
            const el = document.getElementById(elementId);
            el.textContent = status;
            el.className = className;
        }

        async function testLogin() {
            try {
                log('🔐 Testing quick login...');
                const response = await fetch(`${API_BASE}/api/operators/login-quick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    updateStatus('login-status', `✅ Login OK - ${data.operator.name}`, 'success');
                    log(`✅ Login successful: ${data.operator.name}`);
                    log(`🎫 Token: ${authToken.substring(0, 20)}...`);
                } else {
                    updateStatus('login-status', `❌ Login Failed: ${data.message}`, 'error');
                    log(`❌ Login failed: ${data.message}`);
                }
            } catch (error) {
                updateStatus('login-status', `❌ Error: ${error.message}`, 'error');
                log(`❌ Login error: ${error.message}`);
            }
        }

        async function testLoginNormal() {
            try {
                log('🔐 Testing normal login...');
                const response = await fetch(`${API_BASE}/api/operators/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const data = await response.json();
                log(`📋 Normal login response: ${JSON.stringify(data)}`);
            } catch (error) {
                log(`❌ Normal login error: ${error.message}`);
            }
        }

        async function testAnalytics() {
            try {
                log('📊 Testing analytics...');
                const response = await fetch(`${API_BASE}/api/analytics/dashboard`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('analytics-status', '✅ Analytics OK', 'success');
                    log(`✅ Analytics loaded successfully`);
                    
                    const metrics = document.getElementById('analytics-data');
                    metrics.innerHTML = `
                        <div class="metric">📱 Chat Totali: ${data.summary.totalChats}</div>
                        <div class="metric">🟢 Attive: ${data.summary.activeChats}</div>
                        <div class="metric">👥 Con Operatore: ${data.summary.operatorChats}</div>
                        <div class="metric">🎫 Ticket Aperti: ${data.summary.openTickets}</div>
                        <div class="metric">💬 Messaggi: ${data.summary.totalMessages}</div>
                    `;
                    log(`📈 Metrics: ${JSON.stringify(data.summary)}`);
                } else {
                    updateStatus('analytics-status', `❌ Analytics Failed: ${data.error}`, 'error');
                    log(`❌ Analytics failed: ${data.error}`);
                }
            } catch (error) {
                updateStatus('analytics-status', `❌ Error: ${error.message}`, 'error');
                log(`❌ Analytics error: ${error.message}`);
            }
        }

        async function testOperatorStatus() {
            try {
                log('👥 Testing operator status...');
                const response = await fetch(`${API_BASE}/api/operators/status`);
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('operator-status', `✅ ${data.online_operators} operatori online`, 'success');
                    log(`👥 Operators: ${data.online_operators} online, ${data.operators.length} total`);
                } else {
                    updateStatus('operator-status', '❌ Failed', 'error');
                    log(`❌ Operator status failed`);
                }
            } catch (error) {
                updateStatus('operator-status', `❌ Error: ${error.message}`, 'error');
                log(`❌ Operator status error: ${error.message}`);
            }
        }

        async function testWebSocket() {
            try {
                log('🔌 Testing WebSocket...');
                const ws = new WebSocket(`wss://${window.location.host}`);
                
                ws.onopen = () => {
                    updateStatus('websocket-status', '✅ WebSocket Connected', 'success');
                    log('🔌 WebSocket connected');
                    
                    // Test authentication
                    ws.send(JSON.stringify({
                        type: 'operator_auth',
                        operatorId: 'test-operator'
                    }));
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    log(`📨 WebSocket message: ${JSON.stringify(data)}`);
                };
                
                ws.onerror = (error) => {
                    updateStatus('websocket-status', '❌ WebSocket Error', 'error');
                    log(`❌ WebSocket error: ${error.message}`);
                };
                
                // Close after 5 seconds
                setTimeout(() => {
                    ws.close();
                    log('🔌 WebSocket test completed');
                }, 5000);
                
            } catch (error) {
                updateStatus('websocket-status', `❌ Error: ${error.message}`, 'error');
                log(`❌ WebSocket error: ${error.message}`);
            }
        }

        async function testDashboardFiles() {
            try {
                log('📱 Testing dashboard files...');
                
                const files = [
                    '/dashboard/css/dashboard.css',
                    '/dashboard/js/dashboard.js',
                    '/dashboard/manifest.json'
                ];
                
                let success = 0;
                for (const file of files) {
                    try {
                        const response = await fetch(`${API_BASE}${file}`);
                        if (response.ok) {
                            success++;
                            log(`✅ ${file} - OK`);
                        } else {
                            log(`❌ ${file} - ${response.status}`);
                        }
                    } catch (error) {
                        log(`❌ ${file} - Error: ${error.message}`);
                    }
                }
                
                if (success === files.length) {
                    updateStatus('ui-status', '✅ All files loaded', 'success');
                } else {
                    updateStatus('ui-status', `⚠️ ${success}/${files.length} files loaded`, 'error');
                }
            } catch (error) {
                updateStatus('ui-status', `❌ Error: ${error.message}`, 'error');
                log(`❌ File test error: ${error.message}`);
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            log('🚀 Starting automatic tests...');
            setTimeout(testOperatorStatus, 500);
            setTimeout(testDashboardFiles, 1000);
        });
    </script>
</body>
</html>