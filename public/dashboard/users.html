<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• Gestione Utenti - Dashboard Operatori</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        .user-card {
            transition: transform 0.2s;
        }
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .user-avatar {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .role-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block bg-dark sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">üëë Admin Panel</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/">
                                üè† Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/dashboard/users.html">
                                üë• Gestione Utenti
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#" onclick="logout()">
                                üö™ Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">üë• Gestione Utenti</h1>
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        ‚ûï Nuovo Operatore
                    </button>
                </div>

                <!-- Users Grid -->
                <div id="users-container" class="row g-4">
                    <!-- Users will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Nuovo Operatore</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">

                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nome Display</label>
                            <input type="text" class="form-control" id="displayName" placeholder="Es: Mario">
                            <small class="text-muted">Nome mostrato nelle chat</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Avatar (Emoji o URL)</label>
                            <input type="text" class="form-control" id="avatar" placeholder="Es: üòä o https://...">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Specializzazione</label>
                            <input type="text" class="form-control" id="specialization" placeholder="Es: Assistenza tecnica">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Password <span id="passwordRequired">*</span></label>
                            <input type="password" class="form-control" id="password">
                            <small class="text-muted" id="passwordHint">Lascia vuoto per non cambiare</small>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                            <label class="form-check-label" for="isActive">Attivo</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://lucine-chatbot.onrender.com/api';
        let currentUser = null;
        let token = null;

        // Check auth on load
        window.onload = async () => {
            const storedData = localStorage.getItem('currentOperator');
            if (!storedData) {
                window.location.href = '/dashboard/';
                return;
            }

            const data = JSON.parse(storedData);
            token = data.token;
            currentUser = data.operator;

            // Check if user is admin
            if (currentUser.role !== 'ADMIN') {
                alert('‚õî Accesso negato. Solo gli amministratori possono accedere a questa pagina.');
                window.location.href = '/dashboard/';
                return;
            }

            loadUsers();
        };

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderUsers(data.users);
                } else {
                    alert('Errore nel caricamento utenti');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Errore di connessione');
            }
        }

        function renderUsers(users) {
            const container = document.getElementById('users-container');
            container.innerHTML = users.map(user => `
                <div class="col-md-4">
                    <div class="card user-card position-relative">
                        ${user.role === 'ADMIN' ? '<span class="badge bg-warning role-badge">üëë ADMIN</span>' : ''}
                        ${!user.isActive ? '<span class="badge bg-secondary role-badge">‚ùå Disattivo</span>' : ''}

                        <div class="card-body text-center">
                            <div class="user-avatar mx-auto mb-3">
                                ${user.avatar || 'üë§'}
                            </div>

                            <h5 class="card-title">${user.displayName || user.name}</h5>
                            <p class="text-muted small mb-2">@${user.username}</p>
                            <p class="text-muted small">${user.email}</p>

                            ${user.specialization ? `<span class="badge bg-info">${user.specialization}</span>` : ''}

                            <div class="mt-3">
                                ${user.isOnline ? '<span class="badge bg-success">üü¢ Online</span>' : '<span class="badge bg-secondary">‚ö´ Offline</span>'}
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick='editUser(${JSON.stringify(user)})'>
                                    ‚úèÔ∏è Modifica
                                </button>
                                ${user.role !== 'ADMIN' ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="deactivateUser('${user.id}', '${user.username}')">
                                        üóëÔ∏è Disattiva
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCreateUserModal() {
            document.getElementById('userModalTitle').textContent = 'Nuovo Operatore';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('username').disabled = false;
            document.getElementById('email').disabled = false;
            document.getElementById('password').required = true;
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHint').style.display = 'none';

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        function editUser(user) {
            document.getElementById('userModalTitle').textContent = 'Modifica Operatore';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('username').disabled = true;
            document.getElementById('email').value = user.email;
            document.getElementById('email').disabled = true;
            document.getElementById('name').value = user.name;
            document.getElementById('displayName').value = user.displayName || '';
            document.getElementById('avatar').value = user.avatar || '';
            document.getElementById('specialization').value = user.specialization || '';
            document.getElementById('isActive').checked = user.isActive;
            document.getElementById('password').required = false;
            document.getElementById('passwordRequired').style.display = 'none';
            document.getElementById('passwordHint').style.display = 'block';

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const isEdit = !!userId;

            const userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                name: document.getElementById('name').value,
                displayName: document.getElementById('displayName').value,
                avatar: document.getElementById('avatar').value,
                specialization: document.getElementById('specialization').value,
                isActive: document.getElementById('isActive').checked,
                password: document.getElementById('password').value
            };

            try {
                const url = isEdit ? `${API_BASE}/users/${userId}` : `${API_BASE}/users`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                } else {
                    alert('Errore: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Errore di connessione');
            }
        }

        async function deactivateUser(userId, username) {
            if (!confirm(`Sei sicuro di voler disattivare l'operatore ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadUsers();
                } else {
                    alert('Errore: ' + data.error);
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert('Errore di connessione');
            }
        }

        function logout() {
            localStorage.removeItem('currentOperator');
            window.location.href = '/dashboard/';
        }
    </script>
</body>
</html>
